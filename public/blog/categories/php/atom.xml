<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: php | Yet Another Kinopyo Blog]]></title>
  <link href="http://kinopyo.com/blog/categories/php/atom.xml" rel="self"/>
  <link href="http://kinopyo.com/"/>
  <updated>2012-09-29T21:21:12+09:00</updated>
  <id>http://kinopyo.com/</id>
  <author>
    <name><![CDATA[Qihuan Piao]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[PHP プロセス数を指定して実行するマルチスレッド処理(curl_multi)]]></title>
    <link href="http://kinopyo.com/blog/php-multi-thread-with-specific-process-number-using-curl-multi"/>
    <updated>2011-08-09T00:00:00+09:00</updated>
    <id>http://kinopyo.com/blog/php-multi-thread-with-specific-process-number-using-curl-multi</id>
    <content type="html"><![CDATA[<p>curl_multi系を使って、プロセス数を指定して実行するマルチスレッド処理です。</p>

<p>urlは配列で受け取って、もし指定したプロセス数より多い場合は分割して実行するようになってます。</p>

<p>このサンプルコードではこのブログの幾つかのurlに対してtitleを取得しました。</p>

<p><div><script src='https://gist.github.com/1073555.js?file=multi-process-exec.php'></script>
<noscript><pre><code>&lt;?php
/**
* 指定したプロセス数で並列処理を実行する
*
* @param array $url_list URLの配列
* @param boolean $url_as_key 結果配列を返すときに、urlをキーにする
* @param int $timeout タイムアウト秒数 0だと無制限
* @return array 結果配列
*/
function execute($url_list, $url_as_key = false, $timeout=0) {
    // set your process number
    $process = 5;

    $is_over_process = false;
    if ($process &lt; count($url_list)) {
        // chunk url list / process number*
        $url_chunk = array_chunk($url_list, $process);
        $is_over_process = true;
    }

    $ret = array(); 
        
    if ($is_over_process &amp;&amp; !empty($url_chunk)) {

        foreach ($url_chunk as $key =&gt; $url_list) {
            echo &quot;chunk start:{$key}\n&quot;;
            
            $res = fetch_multi_url($url_list, $url_as_key, $timeout);
            if (!empty($res)) {
                $ret = array_merge($ret, $res);
            } else {
                continue;
            }

        }
    } else if (!$is_over_process &amp;&amp; !empty($url_list)){
        $ret = fetch_multi_url($url_list, $url_as_key, $timeout);
    } else {
        echo &quot;url invalid::&quot;;
    }
    
    return $ret;
    
}

/**
 * curl_multi_execの並列処理
 * ほぼboilerplate
 *
* @param array $url_list URLの配列
* @param boolean $url_as_key 結果配列を返すときに、urlをキーにする
* @param int $timeout タイムアウト秒数 0だと無制限
* @return array 結果配列
 */
function fetch_multi_url($url_list, $url_as_key, $timeout) {
    $mh = curl_multi_init();
    foreach ($url_list as $i =&gt; $url) {
        $ch[$i] = curl_init($url);
        curl_setopt($ch[$i],CURLOPT_RETURNTRANSFER,1);

        //タイムアウト
        if ($timeout){
            curl_setopt($ch[$i],CURLOPT_TIMEOUT,$timeout);
        }

        curl_multi_add_handle($mh,$ch[$i]);
    }

    //URLを取得
    //すべて取得するまでループ
    $active = null;
    do {
        $mrc = curl_multi_exec($mh,$active);
    } while ($mrc == CURLM_CALL_MULTI_PERFORM);

    while ($active and $mrc == CURLM_OK) {
        if (curl_multi_select($mh) != -1) {
            do {
                $mrc = curl_multi_exec($mh,$active);
            } while ($mrc == CURLM_CALL_MULTI_PERFORM);
        }
    }

    if ($mrc != CURLM_OK) {
        echo '読み込みエラーが発生しました:'.$mrc;
    }

    //ソースコードを取得
    $res = array();
    foreach ($url_list as $i =&gt; $url) {
        if (($err = curl_error($ch[$i])) == '') {
            // url_as_keyがtrueの場合、urlをキーとして格納
            if ($url_as_key) {
                $res[$url] = curl_multi_getcontent($ch[$i]);
            // そうでない場合は、ただ配列に入れる
            } else {
                $res[$i] = curl_multi_getcontent($ch[$i]);
            }
        } else {
            echo '取得に失敗しました:'.$url_list[$i].'&lt;br /&gt;';
        }
        curl_multi_remove_handle($mh,$ch[$i]);
        curl_close($ch[$i]);
    }
    curl_multi_close($mh);

    return $res;
}


// 並列実行したいurl list
$url_list = array(
    &quot;http://www.kinopyo.com/blog/ipad-2-not-charging-when-connected-to-pc-usb&quot;,
    &quot;http://www.kinopyo.com/blog/the-first-app-i-installed-to-ipad2&quot;,
    &quot;http://www.kinopyo.com/blog/chrome-warn-before-quitting-with-command-q-in-mac&quot;,
    &quot;http://www.kinopyo.com/blog/reply-to-all-always-in-gmail&quot;,
    &quot;http://www.kinopyo.com/blog/lion-fullscreen-shortcut-key-conflict-with-evernote-client&quot;,
    &quot;http://www.kinopyo.com/blog/how-to-set-gesture-for-chrome-to-swipe-back-and-forth-in-lion&quot;,
    &quot;http://www.kinopyo.com/blog/3-free-ebooks-for-study-coffeescript&quot;
);

// start time
$start_time = microtime(true);

// execute
$res = execute($url_list, true);

// execute time
$time = microtime(true) - $start_time;

// play with the result
// here I just get the page title
$titles = array();
foreach ($res as $url =&gt; $html) {
    preg_match('{&lt;title&gt;(.*)&lt;/title&gt;}',$html, $match_title);
    $titles[$url] = $match_title[1];
}

echo &quot;Result:\n&quot;;
echo &quot;time:{$time} sec\n&quot;;
print_r($titles);</code></pre></noscript></div>
</p>

<p>参考：<a href="http://techblog.ecstudio.jp/tech-tips/php-multi.html">PHPでマルチスレッド(バックグラウンド処理)を実現する方法</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[PHP:必要桁数まで0埋めする]]></title>
    <link href="http://kinopyo.com/blog/php-pad-a-number-to-certain-length-with-0"/>
    <updated>2011-07-22T00:00:00+09:00</updated>
    <id>http://kinopyo.com/blog/php-pad-a-number-to-certain-length-with-0</id>
    <content type="html"><![CDATA[<p>```php
// 47 -> 047
sprintf("%03d", 47);</p>

<p>// or</p>

<p>// parameter: string $input , int $pad_length,
str_pad(47, 3, '0', STR_PAD_LEFT);</p>

<p>```</p>

<p>str-padについては：<a href="http://php.net/manual/en/function.str-pad.php">http://php.net/manual/en/function.str-pad.php</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[PEAR HTTP_Requestのサンプルコード]]></title>
    <link href="http://kinopyo.com/blog/pear-http_request-example"/>
    <updated>2011-06-08T00:00:00+09:00</updated>
    <id>http://kinopyo.com/blog/pear-http_request-example</id>
    <content type="html"><![CDATA[<p>仕事で使ったので簡単にサンプルコードをまとめました。</p>

<script type="text/javascript" src="scripts/gist1014278.js"></script>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[PHP:環境構築時に使う接続テストコードまとめ MySQL/Oracle/Memcache/Memcached]]></title>
    <link href="http://kinopyo.com/blog/php-connection-test-code-for-mysql-oracle-memcache-memcached"/>
    <updated>2011-06-03T00:00:00+09:00</updated>
    <id>http://kinopyo.com/blog/php-connection-test-code-for-mysql-oracle-memcache-memcached</id>
    <content type="html"><![CDATA[<p>環境構築時に接続テスト用のコードをまとめました。</p>

<script type="text/javascript" src="scripts/gist.js"></script>


<script type="text/javascript">gist()</script>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Cakephp XML to Array]]></title>
    <link href="http://kinopyo.com/blog/cakephp-xml-to-array"/>
    <updated>2011-05-15T00:00:00+09:00</updated>
    <id>http://kinopyo.com/blog/cakephp-xml-to-array</id>
    <content type="html"><![CDATA[<p>CakephpでXMLを配列に変換するのはとても簡単です。
下記のファンクションを使えば一発でできます。</p>

<p><code>php
uses('Xml');
$xml = new Xml("/path/to/xml");
$xml_array = Set::reverse($xml);
</code></p>
]]></content>
  </entry>
  
</feed>
